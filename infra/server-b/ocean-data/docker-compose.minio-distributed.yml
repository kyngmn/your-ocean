# ğŸŒ ì‹¤ì œ ë‹¤ì¤‘ ì„œë²„ MinIO ë¶„ì‚° ì„¤ì • ì˜ˆì‹œ
# ê° ì„œë²„ì—ì„œ ì‹¤í–‰í•  docker-compose íŒŒì¼ë“¤

# ===============================================
# ì„œë²„1 (192.168.1.101) - docker-compose-node1.yml
# ===============================================
version: '3.8'
services:
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    hostname: minio-node1
    container_name: minio-node1
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_PROMETHEUS_AUTH_TYPE: public

      # ë¶„ì‚° ëª¨ë“œ ì„¤ì •
      MINIO_REGION_NAME: us-east-1
      MINIO_STORAGE_CLASS_STANDARD: "EC:2"     # 2ê°œ íŒ¨ë¦¬í‹° (4ë…¸ë“œ ì¤‘ 2ê°œ ì¥ì•  í—ˆìš©)
      MINIO_STORAGE_CLASS_RRS: "EC:1"          # 1ê°œ íŒ¨ë¦¬í‹° (4ë…¸ë“œ ì¤‘ 1ê°œ ì¥ì•  í—ˆìš©)

    # ğŸ”„ ë¶„ì‚° command: ëª¨ë“  ì„œë²„ì˜ ì‹¤ì œ IP/ë„ë©”ì¸ ì§€ì •
    command: >
      server
      http://192.168.1.101:9000/data1 http://192.168.1.101:9000/data2
      http://192.168.1.102:9000/data1 http://192.168.1.102:9000/data2
      http://192.168.1.103:9000/data1 http://192.168.1.103:9000/data2
      http://192.168.1.104:9000/data1 http://192.168.1.104:9000/data2
      --console-address ":9001"

    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # ì›¹ ì½˜ì†”

    volumes:
      - /mnt/disk1:/data1   # ì²« ë²ˆì§¸ ë””ìŠ¤í¬
      - /mnt/disk2:/data2   # ë‘ ë²ˆì§¸ ë””ìŠ¤í¬ (ê¶Œì¥: ì„œë¡œ ë‹¤ë¥¸ ë¬¼ë¦¬ ë””ìŠ¤í¬)

    networks:
      - minio-distributed

networks:
  minio-distributed:
    driver: bridge

---

# ===============================================
# ì„œë²„2 (192.168.1.102) - docker-compose-node2.yml
# ===============================================
version: '3.8'
services:
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    hostname: minio-node2
    container_name: minio-node2
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}      # ëª¨ë“  ë…¸ë“œ ë™ì¼
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_PROMETHEUS_AUTH_TYPE: public
      MINIO_REGION_NAME: us-east-1            # ëª¨ë“  ë…¸ë“œ ë™ì¼
      MINIO_STORAGE_CLASS_STANDARD: "EC:2"
      MINIO_STORAGE_CLASS_RRS: "EC:1"

    command: >
      server
      http://192.168.1.101:9000/data1 http://192.168.1.101:9000/data2
      http://192.168.1.102:9000/data1 http://192.168.1.102:9000/data2
      http://192.168.1.103:9000/data1 http://192.168.1.103:9000/data2
      http://192.168.1.104:9000/data1 http://192.168.1.104:9000/data2
      --console-address ":9001"

    ports:
      - "9000:9000"
      - "9001:9001"

    volumes:
      - /mnt/disk1:/data1
      - /mnt/disk2:/data2

    networks:
      - minio-distributed

networks:
  minio-distributed:
    driver: bridge

---

# ===============================================
# ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • (HAProxy) - ë³„ë„ ì„œë²„ ë˜ëŠ” ì„œë²„1ì— ì„¤ì¹˜
# ===============================================
# haproxy.cfg íŒŒì¼ ë‚´ìš©:

global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# MinIO S3 API ë¡œë“œë°¸ëŸ°ì‹±
frontend minio_s3_frontend
    bind *:9000
    default_backend minio_s3_backend

backend minio_s3_backend
    balance roundrobin
    server minio1 192.168.1.101:9000 check
    server minio2 192.168.1.102:9000 check
    server minio3 192.168.1.103:9000 check
    server minio4 192.168.1.104:9000 check

# MinIO Console ë¡œë“œë°¸ëŸ°ì‹±
frontend minio_console_frontend
    bind *:9001
    default_backend minio_console_backend

backend minio_console_backend
    balance roundrobin
    server minio1 192.168.1.101:9001 check
    server minio2 192.168.1.102:9001 check
    server minio3 192.168.1.103:9001 check
    server minio4 192.168.1.104:9001 check

---

# ===============================================
# ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ
# ===============================================

#!/bin/bash
# deploy-minio-cluster.sh

SERVERS=("192.168.1.101" "192.168.1.102" "192.168.1.103" "192.168.1.104")
NODE_CONFIGS=("node1" "node2" "node3" "node4")

# ê° ì„œë²„ì— ì„¤ì • ë°°í¬
for i in "${!SERVERS[@]}"; do
    SERVER="${SERVERS[$i]}"
    NODE="${NODE_CONFIGS[$i]}"

    echo "ğŸš€ Deploying to server: $SERVER (${NODE})"

    # ì„¤ì • íŒŒì¼ ë³µì‚¬
    scp docker-compose-${NODE}.yml $SERVER:~/minio/
    scp .env $SERVER:~/minio/

    # ì›ê²© ì‹¤í–‰
    ssh $SERVER "cd ~/minio && docker-compose -f docker-compose-${NODE}.yml up -d"
done

echo "âœ… MinIO ë¶„ì‚° í´ëŸ¬ìŠ¤í„° ë°°í¬ ì™„ë£Œ!"
echo "ğŸŒ S3 API: http://load-balancer:9000"
echo "ğŸ–¥ï¸ Console: http://load-balancer:9001"