🎯 실제 동작 방식 설명

📄 파일 저장 과정 (구체적 예시):

1. 파일 업로드: "video.mp4" (1GB)
   ↓
2. MinIO가 파일을 4개 조각으로 분할:
   조각A: 256MB
   조각B: 256MB
   조각C: 256MB
   조각D: 256MB
   ↓
3. Erasure Coding으로 패리티 생성:
   패리티P: 256MB (A⊕B⊕C⊕D)
   ↓
4. 2서버 4드라이브에 분산 저장:
   서버1-드라이브1: [조각A, 조각C]
   서버1-드라이브2: [조각B]
   서버2-드라이브1: [조각D]
   서버2-드라이브2: [패리티P]

🔍 읽기 과정:
1. 클라이언트가 "video.mp4" 요청
   ↓
2. MinIO가 각 서버에서 조각 병렬 읽기:
   서버1에서: 조각A, B, C 동시 읽기
   서버2에서: 조각D 읽기
   ↓
3. 조각들을 순서대로 합쳐서 원본 파일 복원
   ↓
4. 클라이언트에게 완전한 파일 전송

⚡ 성능 이점:
- 쓰기: 2개 서버에 병렬로 저장 → 약 2배 빠름
- 읽기: 2개 서버에서 병렬로 읽기 → 약 2배 빠름
- 대역폭: 네트워크 대역폭을 2배 활용

🛡️ 장애 복구:
서버1 다운시:
- 남은 것: 조각D + 패리티P (서버2에서)
- 복구 방식: D와 P로는 원본 복구 불가능 ❌
- 결과: 서비스 중단

드라이브1 다운시:
- 남은 것: 조각B + 조각D + 패리티P
- 복구 방식: B⊕D⊕P = A⊕C ✅
- 결과: 여전히 파일 접근 가능

💡 핵심 차이점:
- 로드밸런싱: 요청을 여러 서버로 분산
- MinIO 분산: 데이터 자체를 쪼개서 여러 서버에 저장

---

# ===============================================
# 📊 2서버 분산 저장 원리 상세 설명
# ===============================================

# 🔢 데이터 저장 과정:
# 1. 파일 업로드: "video.mp4" (100MB)
# 2. 청크 분할: 25MB씩 4개 조각 (A, B, C, D)
# 3. 패리티 생성: 1개 패리티 조각 (P)
# 4. 분산 저장:
#    - 서버1-디스크1: 조각A + 조각C
#    - 서버1-디스크2: 조각B + 패리티P
#    - 서버2-디스크1: 조각D
#    - 서버2-디스크2: (백업 메타데이터)

# 🛡️ 장애 허용 시나리오:
# ✅ 가능: 디스크 1개 장애 (예: 서버1-디스크1 장애)
#    → 조각A,C 손실되지만 B,D,P로 복구 가능
# ❌ 불가능: 서버 전체 장애 (예: 서버1 전체 다운)
#    → 조각A,B,C,P 중 다수 손실로 복구 불가능

# 📈 성능 특성:
# - 읽기: 2서버 병렬 접근으로 약 2배 빨라짐
# - 쓰기: 패리티 계산 + 분산 저장으로 약간 느려짐
# - 용량: 실제 사용량 = 원본 데이터 × 1.33 (패리티 33% 오버헤드)

---

# ===============================================
# 🚨 2서버 환경의 한계점과 대안
# ===============================================

# ⚠️ 주요 제약사항:
# 1. 단일 장애점: 서버 1대 다운시 전체 서비스 중단
# 2. 패리티 부족: EC:1만 가능 (디스크 1개 장애만 허용)
# 3. 성능 제한: 최적 성능을 위해서는 4서버 이상 권장

# 💡 2서버 환경 대안 구성:
alternative_2server_simple:
# 🔄 단순 복제 모드 (Mirror)
# - 서버1: 원본 데이터
# - 서버2: 완전 복제본
# - 용량 효율: 50% (2배 저장)
# - 장애 허용: 서버 1대 다운 가능

minio_server1:
# 원본 서버
command: server /data --console-address ":9001"
# 실시간 동기화를 위한 별도 설정 필요

minio_server2:
# 복제 서버 (mc mirror 명령으로 동기화)
command: server /data --console-address ":9001"

---

# ===============================================
# 🔧 실제 배포 스크립트 (2서버용)
# ===============================================

#!/bin/bash
# deploy-2server-minio.sh

SERVER1="192.168.1.101"
SERVER2="192.168.1.102"

echo "🚀 2서버 MinIO 분산 클러스터 배포 시작..."

# 서버1 배포
echo "📡 서버1 ($SERVER1) 배포 중..."
scp docker-compose-server1.yml $SERVER1:~/minio/
scp .env $SERVER1:~/minio/
ssh $SERVER1 "cd ~/minio && docker-compose -f docker-compose-server1.yml up -d"

# 서버2 배포
echo "📡 서버2 ($SERVER2) 배포 중..."
scp docker-compose-server2.yml $SERVER2:~/minio/
scp .env $SERVER2:~/minio/
ssh $SERVER2 "cd ~/minio && docker-compose -f docker-compose-server2.yml up -d"

# 클러스터 상태 확인
echo "🔍 클러스터 상태 확인 중..."
sleep 10
curl -s http://$SERVER1:9000/minio/health/cluster

echo "✅ 배포 완료!"
echo "🌐 S3 API: http://$SERVER1:9000 또는 http://$SERVER2:9000"
echo "🖥️ Console: http://$SERVER1:9001"
echo "⚠️  주의: 서버 1대 장애시 서비스 중단됨"