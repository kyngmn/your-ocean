pipeline {
    agent any

    environment {
        APP_NAME = 'blue-green-demo'
        BLUE_PORT = '3001'
        GREEN_PORT = '3002'
        PROXY_PORT = '3000'
        DOCKER_IMAGE = "${APP_NAME}"
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
    }

    stages {
        stage('ì¤€ë¹„') {
            steps {
                echo 'ğŸš€ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹œì‘!'
                echo "ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}"

                script {
                    // í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
                    try {
                        def blueRunning = sh(
                            script: "docker ps --filter name=${APP_NAME}-blue --filter status=running -q",
                            returnStdout: true
                        ).trim()

                        def greenRunning = sh(
                            script: "docker ps --filter name=${APP_NAME}-green --filter status=running -q",
                            returnStdout: true
                        ).trim()

                        if (blueRunning && !greenRunning) {
                            env.CURRENT_ENV = 'blue'
                            env.TARGET_ENV = 'green'
                            env.TARGET_PORT = env.GREEN_PORT
                            env.CURRENT_PORT = env.BLUE_PORT
                        } else if (greenRunning && !blueRunning) {
                            env.CURRENT_ENV = 'green'
                            env.TARGET_ENV = 'blue'
                            env.TARGET_PORT = env.BLUE_PORT
                            env.CURRENT_PORT = env.GREEN_PORT
                        } else {
                            // ì²˜ìŒ ë°°í¬ê±°ë‚˜ ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš°
                            env.CURRENT_ENV = 'none'
                            env.TARGET_ENV = 'blue'
                            env.TARGET_PORT = env.BLUE_PORT
                            env.CURRENT_PORT = 'none'
                        }

                        echo "í˜„ì¬ í™˜ê²½: ${env.CURRENT_ENV}"
                        echo "ë°°í¬ ëŒ€ìƒ: ${env.TARGET_ENV}"
                        echo "ëŒ€ìƒ í¬íŠ¸: ${env.TARGET_PORT}"

                    } catch (Exception e) {
                        echo "í™˜ê²½ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                        env.CURRENT_ENV = 'none'
                        env.TARGET_ENV = 'blue'
                        env.TARGET_PORT = env.BLUE_PORT
                    }
                }
            }
        }

        stage('ë¹Œë“œ') {
            steps {
                echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                script {
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                    """
                }
                echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
            }
        }

        stage('ë°°í¬') {
            steps {
                echo "ğŸš¢ ${env.TARGET_ENV} í™˜ê²½ì— ë°°í¬ ì¤‘..."
                script {
                    // ëŒ€ìƒ í™˜ê²½ì˜ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
                    sh """
                        docker stop ${APP_NAME}-${env.TARGET_ENV} || true
                        docker rm ${APP_NAME}-${env.TARGET_ENV} || true
                    """

                    // ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                    sh """
                        docker run -d \\
                            --name ${APP_NAME}-${env.TARGET_ENV} \\
                            --network ocean-net \\
                            -p ${env.TARGET_PORT}:3000 \\
                            -e ENVIRONMENT=${env.TARGET_ENV} \\
                            -e VERSION=${BUILD_NUMBER} \\
                            -e PORT=3000 \\
                            ${DOCKER_IMAGE}:${BUILD_NUMBER}
                    """
                }
                echo "âœ… ${env.TARGET_ENV} í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            }
        }

        stage('í—¬ìŠ¤ì²´í¬') {
            steps {
                echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘..."
                script {
                    def maxRetries = 30
                    def retryCount = 0
                    def healthy = false

                    while (retryCount < maxRetries && !healthy) {
                        try {
                            def response = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:${env.TARGET_PORT}/health",
                                returnStdout: true
                            ).trim()

                            if (response == '200') {
                                healthy = true
                                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                            } else {
                                echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (${retryCount + 1}/${maxRetries})"
                                sleep(5)
                                retryCount++
                            }
                        } catch (Exception e) {
                            echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (${retryCount + 1}/${maxRetries})"
                            sleep(5)
                            retryCount++
                        }
                    }

                    if (!healthy) {
                        error("âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
                    }
                }
            }
        }

        stage('íŠ¸ë˜í”½ ì „í™˜') {
            steps {
                echo "ğŸ”„ íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
                script {
                    // ì‹¤ì œ nginx ì„¤ì • íŒŒì¼ ìˆ˜ì •
                    sh """
                        # í˜„ì¬ nginx ì„¤ì •ì—ì„œ blue-green-demo ë¶€ë¶„ì„ ìƒˆ í™˜ê²½ìœ¼ë¡œ ë³€ê²½
                        sed -i 's/proxy_pass http:\\/\\/blue-green-demo-[^:]*:3000/proxy_pass http:\\/\\/blue-green-demo-${env.TARGET_ENV}:3000/' /home/ubuntu/S13P21A303/infra/nginx/conf.d/myocean_server.conf

                        # nginx ì„¤ì • ë¦¬ë¡œë“œ
                        docker exec web-nginx nginx -s reload

                        echo "âœ… Nginx ì„¤ì •ì´ ${env.TARGET_ENV}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
                    """
                }
                echo "âœ… íŠ¸ë˜í”½ì´ ${env.TARGET_ENV} í™˜ê²½ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!"
            }
        }

        stage('ì´ì „ í™˜ê²½ ì •ë¦¬') {
            when {
                expression { env.CURRENT_ENV != 'none' }
            }
            steps {
                echo "ğŸ§¹ ì´ì „ í™˜ê²½ ì •ë¦¬ ì¤‘..."
                script {
                    // 30ì´ˆ ëŒ€ê¸° í›„ ì´ì „ í™˜ê²½ ì •ë¦¬
                    echo "30ì´ˆ í›„ ${env.CURRENT_ENV} í™˜ê²½ì„ ì •ë¦¬í•©ë‹ˆë‹¤..."
                    sleep(30)

                    sh """
                        docker stop ${APP_NAME}-${env.CURRENT_ENV} || true
                        docker rm ${APP_NAME}-${env.CURRENT_ENV} || true
                    """
                }
                echo "âœ… ì´ì „ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ!"
            }
        }
    }

    post {
        success {
            echo """
ğŸ‰ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì„±ê³µ!
ğŸ“Š ë°°í¬ ì •ë³´:
   - ë²„ì „: ${BUILD_NUMBER}
   - í™˜ê²½: ${env.TARGET_ENV}
   - í¬íŠ¸: ${env.TARGET_PORT}
   - í”„ë¡ì‹œ: http://localhost:${PROXY_PORT}
"""
        }
        failure {
            echo "âŒ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹¤íŒ¨!"
            script {
                // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                if (env.CURRENT_ENV != 'none') {
                    echo "ğŸ”„ ë¡¤ë°± ì¤‘..."
                    sh """
                        docker stop ${APP_NAME}-${env.TARGET_ENV} || true
                        docker rm ${APP_NAME}-${env.TARGET_ENV} || true
                    """
                }
            }
        }
        always {
            echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
            sh """
                docker image prune -f
            """
        }
    }
}